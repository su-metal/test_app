# 店舗側の参加方法（LINEミニアプリ運用ガイド）

本ドキュメントは、あなたのプロジェクトにおける**店舗側（storeアプリ）**の参加方法と運用フローをまとめたものです。  
「LINEの友だち登録だけで参加できるの？」という疑問に対し、**友だち登録は導線**、**実運用は店舗管理画面（storeアプリ）**で行う、という方針を明確にします。

---

## ✅ 結論（概要）
- 店舗は **LINE公式アカウントの友だち登録だけでは参加完了になりません**。  
- 参加の実体は **店舗管理画面（storeアプリ）** へのログインです。  
- ただし、**LINEミニアプリ（LIFF）で「参加申請フォーム」を用意**して、LINE内で申請～承認連絡まで完結させるのが理想です。

---

## 🏪 店舗参加の2つの方法

### 方法①：管理者が直接登録（おすすめ）
運営者がSupabaseの `stores` テーブルに店舗情報を登録し、店舗担当者にログインURLを共有します。

**登録項目（例）**
- 店舗ID（自動生成）
- 店舗名（例：すーちゃんラーメン）
- 店舗担当メール
- StripeアカウントID（連携する場合）
- 住所・営業時間 など

**運用フロー**
1. 管理者が `stores` にレコード作成（または管理画面から登録）  
2. 初期パスワード（Supabase Auth）を発行  
3. 店舗担当者へ **ログインURL** と **初期パスワード** を通知  
   - 例：`https://store-suchanramen.duckdns.org/login`  
4. 店舗はログイン後、注文をリアルタイムで確認・引換処理

---

### 方法②：LINE経由で参加申請（LIFFフォーム）
LINE公式アカウント内から申請 → 管理者承認 → storeアカウント発行、という流れです。

**導線設計**
1. **トークメニュー**に「店舗参加申請」を配置（LIFF URLに遷移）  
2. LIFFで**申請フォーム**を表示  
   - 入力項目：店舗名／代表者名／メールアドレス／電話番号 など  
3. 送信時にSupabaseの `store_applications` へ保存  
4. 管理者が承認し、 `stores` へ登録 → 初期パスワード発行  
5. **メール or LINEメッセージ**でログインURLと初期パスワードを通知

**フロー図（テキスト）**
```
[店舗オーナー]
  ↓ LINE公式を友だち追加
  ↓ 「店舗参加申請」タップ（トークメニュー）
  ↓ 申請フォームを送信（LIFF）
-----------------------------
[管理者]
  ↓ Supabaseの申請一覧を確認
  ↓ 承認して stores へ登録
  ↓ 初期パスワードを発行
-----------------------------
[店舗オーナー]
  ↓ ログインURLを受信（メール/LINE）
  ↓ storeアプリへログイン
  ↓ 注文管理・引換運用を開始
```

---

## 🔐 店舗アプリ（store）側の画面構成（例）
- `/login` : Supabase Auth（メール+パスワード）  
- `/dashboard` : 注文一覧（Supabase Realtimeで自動更新）  
- `/orders/[id]` : 注文詳細 + 引換完了ボタン（QR照合）  
- `/settings` : 店舗情報・営業時間設定、Stripe連携 など

**ポイント**
- ユーザーのQRコードには `redeem_code`（引換コード）を含め、storeアプリでスキャン→照合→`orders`更新。  
- 受け取り完了時はユーザーへLINE通知（Messaging API）を自動送信。

---

## 💬 店舗オーナーへの案内テンプレ
- 「店舗参加はこちら」：トークメニューに設置（LIFFの申請フォームへ）  
- 承認後の案内メッセージ（例）  
  - 件名：店舗管理画面のログイン情報のご案内  
  - 本文：ログインURL、初期パスワード、初回ログイン後のパスワード変更のお願い

---

## 🚀 将来的な自動化（拡張）
- **Edge Functions（Supabase Functions）で完全自動化**  
  申請 → 自動承認ルール → `stores` 登録 → 初期PW発行 → メール送信  
- 審査が必要な場合は、**承認待ちステータス**を `store_applications` に保持し、管理画面でボタン1つで承認。

---

## ✅ 運用チェックリスト
- [ ] LINE公式のトークメニューに「店舗参加申請」ボタンを設置した  
- [ ] LIFF申請フォームから `store_applications` へ保存できる  
- [ ] 管理者が承認して `stores` に反映できる  
- [ ] storeアプリのログインURL・初期PWの通知が自動化されている  
- [ ] 注文一覧がRealtimeで自動更新される  
- [ ] 引換完了でユーザーへLINE通知が飛ぶ

---

## 参考：関連URL例
- ユーザー向けミニアプリ：`https://liff.line.me/{LIFF_ID}`  
- 店舗向けログイン：`https://store-suchanramen.duckdns.org/login`

---

このドキュメントを基に、必要なら**「店舗参加申請フォーム（LIFF）」のUIとSupabaseテーブル設計**、**storeアプリのログイン/権限設計**まで具体化できます。

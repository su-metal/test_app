# フードロス削減アプリ 要件・仕様書（v2 / 2025-09-26）

## 差分サマリー（v1 → v2）
- **通知**：在庫復活通知は**不採用**。
- **サイレント時間帯**：**22:00–08:00（固定）** に確定。キュー遅延→朝8時にダイジェスト配信。
- **重複抑止ウィンドウ**：新規出品通知のユーザー向け重複抑止を **3時間** に変更（v1は2時間案）。
- **カート/会計**：**店舗ごとに別会計**を再確認（変更なし）。
- **お気に入りタブ文言**：在庫復活の記述を削除し、**新規出品/値下げ**に限定。

---

## 1. プラットフォーム
- **開始**：LINEアプリ上の **LIFF** アプリとして提供
- **将来**：iOS / Android ネイティブアプリ展開を予定
- **ユーザー登録導線**：QRコードで友だち追加 → LIFF起動

## 2. 決済
- **LINE Pay**：利用しない（サービス停止のため）
- **対応決済**：Stripeによる外部決済（クレジットカード、PayPay）
- **仕様**：**店舗ごとに別会計**（複数店舗の商品は同時決済不可）

## 3. ユーザーアプリ（利用者側）

### 3.1 ナビゲーション
- フッタータブ構成：**ホーム / 探す / お気に入り / 履歴 / アカウント**

### 3.2 ホームタブ
- **表示単位**：商品ではなく **店舗単位**
- **カード内容**：店舗名、距離、評価、タグ、代表商品サンプル（最大3件）、登録商品数（最大5件）
- **操作**：店舗カードタップ → 店舗詳細ページ

### 3.3 店舗詳細ページ
- 店舗情報（名前、住所、評価、距離、タグ）
- 商品ラインナップ（最大5件）
- 商品ごとに数量選択（+/-）
- 画面下部に **カートバー**：選択数・合計金額・「レジへ進む」
- 商品カードタップ → 商品詳細ページ

### 3.4 商品詳細ページ
- 商品名、価格、割引率、受取時間、アレルゲン、在庫残数
- 数量選択（+/-）、カートに追加

### 3.5 レジページ
- **店舗単位**のカート内容サマリ
- 合計金額表示
- 決済手段選択（PayPay / カード）
- 決済完了：**受取チケット生成**（在庫数減算、履歴に保存）

### 3.6 探すタブ
- 初期表示：**マップ（現在地中心）**
- 現在地取得：位置情報許可／不許可時は住所・駅検索にフォールバック
- マップ表示：現在地ピン、周辺店舗ピン（割引率・価格バッジ）
- オーバーレイUI：
  - 検索バー（店舗名/カテゴリ）
  - カテゴリチップ（ベーカリー、惣菜、スーパー、和食、ヴィーガン対応、アレルゲン表示）
  - 距離スライダー（0.5〜5km）
  - 「**3タップで予約完了**」ガイド
- ピンタップ → 詳細シート → 「予約して支払う」 → 決済モーダル → チケット

### 3.7 お気に入りタブ
- 初期状態は空。
- お気に入り **店舗/カテゴリ** を登録すると **新規出品** と **値下げ** の通知が届く（※在庫復活は対象外）。

### 3.8 履歴タブ
- **表示**：受取チケット（最新1件）、過去の注文履歴
- **チケット内容**：商品情報、店舗名、受取時間、チケットID、受取コード、簡易QR

### 3.9 アカウントタブ
- 通知設定：**新規出品、価格ドロップ、受取リマインド**
- 言語・地域設定：日本語 / JPY / 東京（初期値）
- ヘルプ & ポリシー：FAQ、返金・不来店ポリシー、利用規約/プライバシー

## 4. 店舗アプリ（出品側）※未実装
- 店舗ごとのダッシュボード想定
- 登録商品数：最大5件
- 機能案：商品登録/編集、受取スキャン、日次レポート

## 5. 在庫・引当仕様
- 在庫数 (`left`) を商品に保持
- 数量選択で仮引当せず、**決済確定時に在庫を減算**

## 6. 通知仕様（ユーザーアプリ）

### 6.1 通知チャネル
- **LINE Push**：LINE Messaging API によるプッシュ通知（友だち登録＆同意済みが前提）
- **アプリ内通知**：LIFF起動中のトースト/モーダル、バッジ（静的）
- **将来**：メール/プッシュ（ネイティブアプリ）

### 6.2 通知タイプ
1) **新規出品通知**
   - 対象：お気に入り店舗/カテゴリ
   - トリガー：店舗が当日分の余剰を新規出品
   - 表示：店舗名、代表商品/価格、受取時間帯、残数バッジ、クイックアクション
2) **価格ドロップ通知**
   - トリガー：`price` が直近価格から `>=X%` 低下
   - 表示：旧価格→新価格、割引率、受取時間帯
3) **受取リマインド**
   - トリガー：注文確定（チケット発行）
   - スケジュール：`T-60分` / `T-15分`（ユーザー設定で片方/両方/OFF）
4) **取引系（情報）**：決済完了/チケット発行、返金/キャンセル、受取完了（店舗スキャン）

※ **在庫復活通知は実装しない**。

### 6.3 配信ロジック
- **パーソナライズ条件**
  - 距離フィルタ：ユーザーの半径設定（デフォルト=探すタブの直近値、例 `2km`）以内
  - カテゴリ一致：選択チップに一致
- **重複抑止/集約**
  - 同一店舗の **新規出品通知** は **3時間に1回** まで（`store_id + user_id` でキー化）
  - 複数商品の新規出品は **ダイジェスト** 化（代表1件＋「他n件」）
  - 1ユーザーあたりの **デイリー上限**：新規出品系3通、価格ドロップ1通（将来ABで最適化）
- **サイレント時間帯**：**22:00–08:00**（Asia/Tokyo）。キューに積み、**08:00に朝ダイジェスト**配信
- **再送・リトライ**：LINE APIエラー時は指数バックオフ（最大3回）。`blocked`/`unsubscribed`は即停止

### 6.4 同意・設定（アカウントタブ）
- トグル：新規出品（ON/OFF）／価格ドロップ（ON/OFF）／受取リマインド `T-60/T-15`（各ON/OFF）
- 範囲：お気に入り **店舗単位**／**カテゴリ単位** で細分化
- 解除：トークで「停止/解除」で**すべて停止**、または「出品停止」等のキーワードで種別停止

### 6.5 メッセージ設計（例：LINE）
- v1のテンプレートをベースに、在庫復活関連の文言を削除。具体テンプレートは別紙「通知テンプレート（最新版）」参照。

## 7. データモデル（サマリ）
- `user_notification_pref`：`user_id`, `new_listing:boolean`, `price_drop:boolean`, `remind_60:boolean`, `remind_15:boolean`, `radius_km:number`, `quiet_hours:boolean`
- `subscriptions`：`user_id`, `store_id?`, `category?`, `created_at`
- `notification_queue`：`id`, `user_id`, `type`, `payload(json)`, `scheduled_at`, `idempotency_key`, `status`
- `notification_send`：`id`, `queue_id`, `channel`, `sent_at`, `result`, `error_code`
- `orders`：`pickup_start`, `pickup_end`, `store_id`, `user_id`

## 8. API/ジョブ
- `POST /events/listing_created`：新規出品を受けキュー投入
- `POST /events/price_updated`：価格変更イベント
- `POST /notifications/queue`：任意通知の投入（管理/運用）
- **ワーカー**：キュー消化、サイレント時間帯の遅延配信、リトライ/デッドレター
- **バッチ**：朝ダイジェスト（08:00）、日次メトリクス集計（AM 03:00）

## 9. セキュリティ/コンプライアンス
- LINE規約順守、**明確な同意取得**、いつでも解除可能
- 収集データは最小限（`userId`、通知設定、購買/お気に入りの関連ID）
- 署名付きdeeplinkの検討（改竄防止）

## 10. 計測/KPI
- 配信数/到達率、クリック率（deeplink起動）、予約コンバージョン、未受取率
- テンプレート別効果比較、時間帯別効果、しきい値チューニング（AB）

## 11. エッジケース
- 在庫が瞬時に売り切れ：在庫確認APIで即時バリデーション、売切れ時は`品切れ`トースト
- 受取時間の変更：既存リマインドをキャンセルし、新スケジュールを再登録
- ユーザーがブロック：ステータス更新し配信停止、UIで「通知が停止されています」を表示

## 12. QAチェックリスト（抜粋）
- 距離/カテゴリ設定を変えて **新規出品通知** が届く/届かないを確認
- 夜間に入った **新規出品** が **朝8時にダイジェスト** 送信される
- 同一店舗の連続出品が **3時間ルール** で抑止される
- リマインド `T-60/T-15` のON/OFF切替が反映される
- 解除キーワードで即停止→再有効化で再び届く

---

### 付録：通知テンプレート（最新版）
> 変数は `{{ }}` で表記。`liff://app/{{LIFF_ID}}?r={{ROUTE}}` を想定。v1 から在庫復活文言を削除。

1) **新規出品（単品）**／2) **新規出品（ダイジェスト）**／3) **価格ドロップ**／4) **受取リマインド**／5) **取引系** のFlexテンプレートは v1 を踏襲（本文は在庫復活関連を除去）。必要に応じて別ドキュメントでJSON雛形を管理。


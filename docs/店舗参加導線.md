こちらが、あなたの現状方針（＝**店舗側は Web 管理アプリ＋ Supabase Auth 一本化、LINE ログイン不要**）に合わせて書き換えた最新版です 👇
直接上書きできる Markdown です。

---

````md
# 店舗参加導線・実装機能まとめ（2025 年 10 月改訂）

## 🎯 目的

本プロジェクトでは「LINE ミニアプリを通じて、ユーザーが注文・受取を行い、店舗が独自に管理できる仕組み」を実装することを目的とする。  
店舗は自前の管理画面を持ち、受取時間・商品・在庫などを自律的に設定・運用できる。

---

## 🏗 全体構成

- **環境**: Next.js App Router（Monorepo 構成）
- **サーバー**: Supabase（Auth + Database + Storage）
- **クライアント構成**:
  - **ユーザー側**: LINE ミニアプリ（注文・引換用）
  - **店舗側**: Web 管理アプリ（ブラウザアクセス）

---

## 🪧 店舗参加の導線（フロー概要）

1. **店舗申請フォーム入力**

   - 店舗が参加申請フォームに必要事項を入力。
   - フォーム送信先: `/store/applications`
   - 申請内容は `public.store_applications` に保存。

2. **管理者承認フロー**

   - 管理画面 `/admin/applications` にて申請リストを表示。
   - 管理者が「承認」を実行すると以下が自動化:
     - `auth.admin.createUser()` で **店舗用ユーザー** を Supabase Auth に作成。
     - 該当店舗情報を `public.stores` に登録。
     - 初期設定（pickup プリセットなど）を自動生成。
   - 登録完了後、店舗へ **ログイン用メール** を送信（初回パスワード設定可）。

   > 初期パスワードは仮設定（例: `Passw0rd!`）として、初回ログイン時に変更を促す。

3. **店舗ログイン**

   - `/login` ページで **メール + パスワード** によりサインイン。
   - 成功後は `/`（トップ画面）へ遷移。
   - Supabase Auth のセッションがブラウザに保持され、再ログイン不要。

4. **店舗ダッシュボード**

   ログイン後は以下の項目を管理できる：

   - 店舗情報（店名・説明・住所など）
   - 営業時間・受取時間プリセット
   - 商品登録・在庫更新
   - 注文履歴の確認

   これらは Supabase の該当テーブル（`stores`, `store_pickup_presets`, `store_items` など）へ直接反映される。

5. **LINE ミニアプリ連携（ユーザー側のみ）**

   - 一般ユーザーは LINE ミニアプリ上で店舗を閲覧・注文・引換。
   - 店舗側は **Web 管理アプリ** から運用。  
     → 店舗機能では **LINE ログインを使用しない**。  
     → 店舗の本人認証は Supabase Auth に統一。

---

## ⚙ 実装された主要機能

### 1. 店舗申請フォーム

- `/store/applications` にてフォーム入力を受付。
- バリデーション後、`store_applications` に INSERT。

### 2. 管理者承認 API

- `/api/admin/approve-store`
- 処理内容:
  - 店舗申請データからユーザーを作成 (`auth.admin.createUser`)。
  - 新規店舗を `public.stores` に登録し、`auth_user_id` を紐づけ。
  - 初期プリセット（`store_pickup_presets`）を生成。

### 3. Supabase Auth 管理拡張

- `apps/store/src/app/api/dev/set-password/route.ts`
  - 管理者が任意ユーザーのパスワードを再設定可能。
  - 開発時のみ有効（`ADMIN_DASHBOARD_SECRET` による制御）。

### 4. 店舗ログインと遷移統一

- ログイン後のリダイレクトを `/` に統一。
  ```diff
  - const next = new URLSearchParams(location.search).get('next') || '/dashboard';
  + const next = new URLSearchParams(location.search).get('next') || '/';
  ```
````

### 5. 受取時間プリセット管理

- API パス: `/api/presets/upsert`
- 現行仕様では **Supabase Auth 認証ユーザーのみが操作可能**。
  → LINE 認証は不要。
  → RLS により `auth.uid() = stores.auth_user_id` のみ更新可。

### 6. RLS 設計

- `store_pickup_presets`, `stores`, `store_applications` に RLS を設定。
- 条件例:

  ```sql
  create policy "store_own_data"
    on store_pickup_presets
    for all
    using (auth.uid() = stores.auth_user_id);
  ```

### 7. 店舗メンバー権限 (`store_members`)

- 複数スタッフでの運用を想定。
- `store_members (store_id, auth_user_id, role)` によりロール管理。
- API 側で `store_members` 一致を確認して編集権限を許可。

---

## 🔐 環境変数整理

| 変数名                          | 用途                                 | スコープ     |
| ------------------------------- | ------------------------------------ | ------------ |
| `NEXT_PUBLIC_SUPABASE_URL`      | Supabase 接続先                      | 共通         |
| `SUPABASE_SERVICE_ROLE_KEY`     | service_role キー（サーバー API 用） | サーバー     |
| `NEXT_PUBLIC_SUPABASE_ANON_KEY` | anon キー（クライアント用）          | クライアント |
| `ADMIN_DASHBOARD_SECRET`        | 開発専用 API のシークレット          | サーバー     |

> ※ 店舗側では `NEXT_PUBLIC_LIFF_ID` や `LINE_CHANNEL_ID` は不要。

---

## ✅ 完了済み要件

| 機能                   | 状態 | 備考                                |
| ---------------------- | ---- | ----------------------------------- |
| 店舗申請フォーム       | ✅   | `store_applications` 登録済         |
| 管理者承認フロー       | ✅   | approve-store API 実装済            |
| 初期 PW 設定 / 再発行  | ✅   | 開発用 API 経由                     |
| ログイン画面修正       | ✅   | `/` に統一                          |
| 受取時間プリセット編集 | ✅   | Supabase Auth に統一（LINE 不要）   |
| RLS 制御               | ✅   | 店舗 ID / Auth ユーザー紐づけで運用 |
| store_members 権限     | ✅   | 実装済                              |

---

## 📈 今後の拡張案

- 店舗の **商品管理 API** を `/api/items/upsert` に分離。
- 管理パネルで申請履歴・稼働状況を可視化。
- スタッフ招待（メール経由）機能を追加。
- 店舗ダッシュボードの UI 改善（統計・売上ビューなど）。

---

**最終更新:** 2025-10-23
**作成者:** アプリ開発支援チーム（店舗運用 Web 化対応版）

```

---

このバージョンでは：
- 店舗側から **LINE認証を完全排除**
- 「店舗Webログイン（Supabase Auth）」を中心に整理
- 店舗参加〜運用までが一貫してWebで完結

```


# 現在のデータベース構成（Supabase） - 差分反映版

> プロジェクト: アプリ作成 / 環境: 開発（Anon Key, RLS: 開発用全許可）  
> 更新日: 2025-10-17（JST）  
> 元ファイル: データベース構成（supabase）_2025_10_10.md

---

## 変更概要

| 区分 | テーブル | 内容 | 詳細 |
|------|-----------|------|------|
| 🆕 新規 | `stores` | 店舗メタ情報管理用テーブルを新設 | TEL / URL / 営業時間 / 定休日 / カテゴリー等を保持 |
| ➕ 追加 | `stores` | 列追加 | `tel`, `url`, `hours`, `holiday`, `category` |
| ✅ 変更なし | `products` | 構造維持 | `image_url` は依然として存在しない |
| ✅ 変更なし | `orders` | 構造維持 | `placed_at DEFAULT now()` を継続推奨 |

---

## 1) stores テーブル定義（新規）

```sql
create table if not exists public.stores (
  id uuid primary key default gen_random_uuid(),
  name text not null,
  address text,
  lat double precision,
  lng double precision,
  cover_image_path text,
  current_pickup_slot_no integer,
  tel text,
  url text,
  hours text,
  holiday text,
  category text
);
```

### チェック制約
```sql
alter table public.stores
  add constraint if not exists stores_tel_format_chk
    check (tel is null or tel ~ '^\+?[0-9][0-9\-\s\(\)]{6,}$');

alter table public.stores
  add constraint if not exists stores_url_format_chk
    check (url is null or url ~* '^(https?://)');
```

### コメント
- `tel` : 店舗電話番号（例: 0532-000-0001）
- `url` : 公式サイトURL（例: https://example.com/store/...）
- `hours` : 営業時間（例: 10:00-19:00）
- `holiday` : 定休日（例: 火曜 / 不定休）
- `category` : カテゴリー（例: ベーカリー）

---

## 2) 他テーブル（変更なし）

### products（商品）
- 列構成：id, store_id, name, price, stock, updated_at  
- インデックス：`idx_products_store_id`, `idx_products_store_id_stock`  
- `image_url` は存在しない。

### orders（注文）
- 列構成：id, store_id, code, customer, items, total, placed_at, status  
- `placed_at DEFAULT now()` を採用。  
- ステータス：`PENDING` / `FULFILLED`。

---

## 3) RLS（Row Level Security）

開発環境では全許可。stores にも同等ポリシーを適用。

```sql
alter table public.stores enable row level security;
create policy if not exists "dev all stores" on public.stores
  for all using (true) with check (true);
```

---

## 4) Realtime（購読）

- 対象: `public.orders`
- イベント: UPDATE / INSERT  
- 備考: SELECT ポリシーが有効でないと UPDATE 通知が届かない。

---

## 5) 便利クエリ（更新）

```sql
-- 店舗一覧（新項目含む）
select id, name, tel, url, hours, holiday, category from public.stores;

-- 店舗ごとの商品在庫
select id, store_id, name, price, stock
from public.products
where store_id = 'YOUR-STORE-UUID' and stock > 0
order by updated_at desc nulls last;

-- 直近の注文
select id, code, customer, total, status, placed_at
from public.orders
where store_id = 'YOUR-STORE-UUID'
order by placed_at desc nulls last
limit 50;
```

---

## 6) 環境変数（変更なし）

- `NEXT_PUBLIC_SUPABASE_URL`
- `NEXT_PUBLIC_SUPABASE_ANON_KEY`
- `NEXT_PUBLIC_STORE_ID`

---

## 7) 差分まとめ

- stores テーブルの新設および5列追加  
- products / orders 構成は変更なし  
- RLS 全許可方針は維持  
- Realtime は引き続き orders UPDATE を購読

---

> **このファイルは**「2025-10-10 時点構成」と「現在の Supabase 構成」の比較を反映しています。


# 現在のデータベース構成（Supabase）

> プロジェクト: アプリ作成 / 環境: 開発（Anon Key, RLS: 開発用全許可）  
> 日付: 2025-10-17（JST）

---

## 1) テーブル概要

### products（商品）
- **列**
  - `id` **uuid** (PK)
  - `store_id` **uuid** (NOT NULL)
  - `name` **text**
  - `price` **numeric**
  - `stock` **integer**
  - `updated_at` **timestamptz DEFAULT now()**
- **インデックス**
  - `idx_products_store_id`
  - `idx_products_store_id_stock`
- **備考**
  - `image_url` は存在しない。

---

### orders（注文）
- **列**
  - `id` **uuid** (PK)
  - `store_id` **uuid** (NOT NULL)
  - `code` **text** （6桁コード）
  - `customer` **text**
  - `items` **jsonb**
  - `total` **numeric**
  - `placed_at` **timestamptz DEFAULT now()**
  - `status` **text** （`PENDING` / `FULFILLED`）
- **インデックス**
  - `idx_orders_store_id`
  - `idx_orders_status`
  - `idx_orders_code`
- **備考**
  - `status` は `PENDING` / `FULFILLED` のみ。
  - Realtime: `UPDATE` イベント購読。

---

### stores（店舗）
- **列**
  - `id` **uuid** (PK)
  - `name` **text**
  - `address` **text**
  - `lat` **double precision**
  - `lng` **double precision**
  - `cover_image_path` **text**
  - `current_pickup_slot_no` **integer**
  - `tel` **text** （例: 0532-000-0001）
  - `url` **text** （例: https://example.com/store/...）
  - `hours` **text** （例: 10:00-19:00）
  - `holiday` **text** （例: 火曜 / 不定休）
  - `category` **text** （例: ベーカリー）
- **制約**
  - `stores_tel_format_chk`: 電話番号形式をチェック（数値・ハイフン許可）
  - `stores_url_format_chk`: URLは http/https のみ許可
- **備考**
  - 店舗メタ情報（営業時間・定休日・カテゴリ・TEL・URL）はすべてここで管理。

---

## 2) RLS（Row Level Security）

開発中は全許可。

```sql
alter table public.products enable row level security;
alter table public.orders enable row level security;
alter table public.stores enable row level security;

create policy if not exists "dev all products" on public.products for all using (true) with check (true);
create policy if not exists "dev all orders" on public.orders for all using (true) with check (true);
create policy if not exists "dev all stores" on public.stores for all using (true) with check (true);
```

---

## 3) Realtime（購読）

- 対象: `public.orders`
- イベント: UPDATE / INSERT
- 備考: SELECT ポリシーが必要。`status='FULFILLED'` 更新を購読。

---

## 4) 便利クエリ

```sql
-- 店舗一覧
select id, name, tel, url, hours, holiday, category from public.stores;

-- 店舗ごとの商品在庫
select id, store_id, name, price, stock
from public.products
where store_id = 'YOUR-STORE-UUID' and stock > 0
order by updated_at desc nulls last;

-- 直近の注文
select id, code, customer, total, status, placed_at
from public.orders
where store_id = 'YOUR-STORE-UUID'
order by placed_at desc nulls last
limit 50;
```

---

## 5) 環境変数

- `NEXT_PUBLIC_SUPABASE_URL`
- `NEXT_PUBLIC_SUPABASE_ANON_KEY`
- `NEXT_PUBLIC_STORE_ID`


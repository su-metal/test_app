
# 現在のデータベース構成（Supabase）

> プロジェクト: アプリ作成 / 環境: 開発（Anon Key, RLS: 開発用全許可）  
> 更新日: 2025-10-17（JST）

---

## 1) テーブル概要

### products（商品）
- **確認済みの列**
  - `id` **uuid** (PK)
  - `store_id` **uuid** (NOT NULL)
  - `name` **text**
  - `price` **numeric**
  - `stock` **integer**
  - `updated_at` **timestamptz DEFAULT now()**
- **存在しない列**
  - `image_url` は存在しない
- **インデックス**
  - `idx_products_store_id`
  - `idx_products_store_id_stock`

---

### orders（注文）
- **列**
  - `id` **uuid** (PK)
  - `store_id` **uuid** (NOT NULL)
  - `code` **text**  … 6桁コード（例: "000123"）
  - `customer` **text**
  - `items` **jsonb**  … `[{ id, name, qty, price }]`
  - `total` **numeric**
  - `placed_at` **timestamptz DEFAULT now()**
  - `status` **text**  … `PENDING` / `FULFILLED`
- **インデックス**
  - `idx_orders_store_id`
  - `idx_orders_status`
  - `idx_orders_code`
- **備考**
  - UI では `FULFILLED` を `redeemed` として扱う

---

### stores（店舗）
> 🔹 新規追加（2025-10-17 反映）

- **列**
  - `id` **uuid** (PK)
  - `name` **text**
  - `address` **text**
  - `lat` **double precision**
  - `lng` **double precision**
  - `cover_image_path` **text**
  - `current_pickup_slot_no` **integer**
  - `tel` **text** （例: 0532-000-0001）
  - `url` **text** （例: https://example.com/store/...）
  - `hours` **text** （例: 10:00-19:00）
  - `holiday` **text** （例: 火曜 / 不定休）
  - `category` **text** （例: ベーカリー）

#### チェック制約
```sql
alter table public.stores
  add constraint if not exists stores_tel_format_chk
    check (tel is null or tel ~ '^\+?[0-9][0-9\-\s\(\)]{6,}$');

alter table public.stores
  add constraint if not exists stores_url_format_chk
    check (url is null or url ~* '^(https?://)');
```

#### コメント
- `tel` : 店舗電話番号  
- `url` : 公式サイト URL  
- `hours` : 営業時間  
- `holiday` : 定休日  
- `category` : カテゴリー（例: ベーカリー / カフェ 等）

---

## 2) RLS（Row Level Security）

開発環境では全許可。

```sql
alter table public.products enable row level security;
alter table public.orders enable row level security;
alter table public.stores enable row level security;

create policy if not exists "dev all products" on public.products for all using (true) with check (true);
create policy if not exists "dev all orders" on public.orders for all using (true) with check (true);
create policy if not exists "dev all stores" on public.stores for all using (true) with check (true);
```

---

## 3) Realtime（購読）

- 対象: `public.orders`
- イベント: UPDATE / INSERT
- 備考: SELECT ポリシーが必要。`status='FULFILLED'` 更新で購読。

---

## 4) データ整合 / 運用要点

- **orders.code** は 6桁ゼロ埋め文字列。  
- **placed_at** は DB 側で `DEFAULT now()`。  
- **items** は JSONB で `{ id, name, qty, price }` を保持。

---

## 5) 便利クエリ

```sql
-- 店舗一覧（新項目含む）
select id, name, tel, url, hours, holiday, category from public.stores;

-- 商品在庫
select id, store_id, name, price, stock
from public.products
where store_id = 'YOUR-STORE-UUID' and stock > 0
order by updated_at desc nulls last;

-- 直近注文
select id, code, customer, total, status, placed_at
from public.orders
where store_id = 'YOUR-STORE-UUID'
order by placed_at desc nulls last
limit 50;
```

---

## 6) 環境変数

- `NEXT_PUBLIC_SUPABASE_URL`
- `NEXT_PUBLIC_SUPABASE_ANON_KEY`
- `NEXT_PUBLIC_STORE_ID`

---

## 7) 差分要約（2025-10-10 → 現在）

| 区分 | テーブル | 内容 |
|------|-----------|------|
| ➕ 新設 | `stores` | TEL / URL / 営業時間 / 定休日 / カテゴリーを含む店舗情報管理用テーブルを追加 |
| ✅ 維持 | `products` | 構成変更なし (`image_url` は依然非存在) |
| ✅ 維持 | `orders` | 構成変更なし（`placed_at DEFAULT now()` 採用） |
| ⚙️ RLS | 全テーブル | 開発用全許可ポリシーを stores にも適用 |

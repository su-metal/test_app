
# ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹æˆï¼ˆSupabaseï¼‰

> ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: ã‚¢ãƒ—ãƒªä½œæˆ / ç’°å¢ƒ: é–‹ç™ºï¼ˆAnon Key, RLS: é–‹ç™ºç”¨å…¨è¨±å¯ï¼‰  
> æ›´æ–°æ—¥: 2025-10-17ï¼ˆJSTï¼‰

---

## 1) ãƒ†ãƒ¼ãƒ–ãƒ«æ¦‚è¦

### productsï¼ˆå•†å“ï¼‰
- **ç¢ºèªæ¸ˆã¿ã®åˆ—**
  - `id` **uuid** (PK)
  - `store_id` **uuid** (NOT NULL)
  - `name` **text**
  - `price` **numeric**
  - `stock` **integer**
  - `updated_at` **timestamptz DEFAULT now()**
- **å­˜åœ¨ã—ãªã„åˆ—**
  - `image_url` ã¯å­˜åœ¨ã—ãªã„
- **ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹**
  - `idx_products_store_id`
  - `idx_products_store_id_stock`

---

### ordersï¼ˆæ³¨æ–‡ï¼‰
- **åˆ—**
  - `id` **uuid** (PK)
  - `store_id` **uuid** (NOT NULL)
  - `code` **text**  â€¦ 6æ¡ã‚³ãƒ¼ãƒ‰ï¼ˆä¾‹: "000123"ï¼‰
  - `customer` **text**
  - `items` **jsonb**  â€¦ `[{ id, name, qty, price }]`
  - `total` **numeric**
  - `placed_at` **timestamptz DEFAULT now()**
  - `status` **text**  â€¦ `PENDING` / `FULFILLED`
- **ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹**
  - `idx_orders_store_id`
  - `idx_orders_status`
  - `idx_orders_code`
- **å‚™è€ƒ**
  - UI ã§ã¯ `FULFILLED` ã‚’ `redeemed` ã¨ã—ã¦æ‰±ã†

---

### storesï¼ˆåº—èˆ—ï¼‰
> ğŸ”¹ æ–°è¦è¿½åŠ ï¼ˆ2025-10-17 åæ˜ ï¼‰

- **åˆ—**
  - `id` **uuid** (PK)
  - `name` **text**
  - `address` **text**
  - `lat` **double precision**
  - `lng` **double precision**
  - `cover_image_path` **text**
  - `current_pickup_slot_no` **integer**
  - `tel` **text** ï¼ˆä¾‹: 0532-000-0001ï¼‰
  - `url` **text** ï¼ˆä¾‹: https://example.com/store/...ï¼‰
  - `hours` **text** ï¼ˆä¾‹: 10:00-19:00ï¼‰
  - `holiday` **text** ï¼ˆä¾‹: ç«æ›œ / ä¸å®šä¼‘ï¼‰
  - `category` **text** ï¼ˆä¾‹: ãƒ™ãƒ¼ã‚«ãƒªãƒ¼ï¼‰

#### ãƒã‚§ãƒƒã‚¯åˆ¶ç´„
```sql
alter table public.stores
  add constraint if not exists stores_tel_format_chk
    check (tel is null or tel ~ '^\+?[0-9][0-9\-\s\(\)]{6,}$');

alter table public.stores
  add constraint if not exists stores_url_format_chk
    check (url is null or url ~* '^(https?://)');
```

#### ã‚³ãƒ¡ãƒ³ãƒˆ
- `tel` : åº—èˆ—é›»è©±ç•ªå·  
- `url` : å…¬å¼ã‚µã‚¤ãƒˆ URL  
- `hours` : å–¶æ¥­æ™‚é–“  
- `holiday` : å®šä¼‘æ—¥  
- `category` : ã‚«ãƒ†ã‚´ãƒªãƒ¼ï¼ˆä¾‹: ãƒ™ãƒ¼ã‚«ãƒªãƒ¼ / ã‚«ãƒ•ã‚§ ç­‰ï¼‰

---

## 2) RLSï¼ˆRow Level Securityï¼‰

é–‹ç™ºç’°å¢ƒã§ã¯å…¨è¨±å¯ã€‚

```sql
alter table public.products enable row level security;
alter table public.orders enable row level security;
alter table public.stores enable row level security;

create policy if not exists "dev all products" on public.products for all using (true) with check (true);
create policy if not exists "dev all orders" on public.orders for all using (true) with check (true);
create policy if not exists "dev all stores" on public.stores for all using (true) with check (true);
```

---

## 3) Realtimeï¼ˆè³¼èª­ï¼‰

- å¯¾è±¡: `public.orders`
- ã‚¤ãƒ™ãƒ³ãƒˆ: UPDATE / INSERT
- å‚™è€ƒ: SELECT ãƒãƒªã‚·ãƒ¼ãŒå¿…è¦ã€‚`status='FULFILLED'` æ›´æ–°ã§è³¼èª­ã€‚

---

## 4) ãƒ‡ãƒ¼ã‚¿æ•´åˆ / é‹ç”¨è¦ç‚¹

- **orders.code** ã¯ 6æ¡ã‚¼ãƒ­åŸ‹ã‚æ–‡å­—åˆ—ã€‚  
- **placed_at** ã¯ DB å´ã§ `DEFAULT now()`ã€‚  
- **items** ã¯ JSONB ã§ `{ id, name, qty, price }` ã‚’ä¿æŒã€‚

---

## 5) ä¾¿åˆ©ã‚¯ã‚¨ãƒª

```sql
-- åº—èˆ—ä¸€è¦§ï¼ˆæ–°é …ç›®å«ã‚€ï¼‰
select id, name, tel, url, hours, holiday, category from public.stores;

-- å•†å“åœ¨åº«
select id, store_id, name, price, stock
from public.products
where store_id = 'YOUR-STORE-UUID' and stock > 0
order by updated_at desc nulls last;

-- ç›´è¿‘æ³¨æ–‡
select id, code, customer, total, status, placed_at
from public.orders
where store_id = 'YOUR-STORE-UUID'
order by placed_at desc nulls last
limit 50;
```

---

## 6) ç’°å¢ƒå¤‰æ•°

- `NEXT_PUBLIC_SUPABASE_URL`
- `NEXT_PUBLIC_SUPABASE_ANON_KEY`
- `NEXT_PUBLIC_STORE_ID`

---

## 7) å·®åˆ†è¦ç´„ï¼ˆ2025-10-10 â†’ ç¾åœ¨ï¼‰

| åŒºåˆ† | ãƒ†ãƒ¼ãƒ–ãƒ« | å†…å®¹ |
|------|-----------|------|
| â• æ–°è¨­ | `stores` | TEL / URL / å–¶æ¥­æ™‚é–“ / å®šä¼‘æ—¥ / ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’å«ã‚€åº—èˆ—æƒ…å ±ç®¡ç†ç”¨ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¿½åŠ  |
| âœ… ç¶­æŒ | `products` | æ§‹æˆå¤‰æ›´ãªã— (`image_url` ã¯ä¾ç„¶éå­˜åœ¨) |
| âœ… ç¶­æŒ | `orders` | æ§‹æˆå¤‰æ›´ãªã—ï¼ˆ`placed_at DEFAULT now()` æ¡ç”¨ï¼‰ |
| âš™ï¸ RLS | å…¨ãƒ†ãƒ¼ãƒ–ãƒ« | é–‹ç™ºç”¨å…¨è¨±å¯ãƒãƒªã‚·ãƒ¼ã‚’ stores ã«ã‚‚é©ç”¨ |

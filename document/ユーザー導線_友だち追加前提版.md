# 🧭 ユーザー導線（友だち追加前提版）

本ドキュメントは、ユーザーが LINE 公式アカウントを友だち追加し、\
ミニアプリ（use
アプリ）を通じて注文・受取・チケット利用を行う導線設計を示す。

------------------------------------------------------------------------

## 🎯 目的

-   一般ユーザーが **LINE 公式アカウントを入口として**
    アプリを利用する。
-   **初回：友だち追加 → ミニアプリ起動 → 注文**
    の流れをワンステップで完結。
-   **再訪：リッチメニューや通知メッセージから1タップで再起動**
    できるようにする。

------------------------------------------------------------------------

## 🏗 全体フロー

``` text
店頭・Web・SNSなどでQR掲示
        ↓
📱 ユーザーがQRをスキャン
        ↓
① LINE公式アカウント友だち追加（https://lin.ee/...）
        ↓
② 自動あいさつメッセージ送信
       「ご利用ありがとうございます！下のボタンからアプリを開けます👇」
       [ミニアプリを開く] ボタン → LIFF起動URL（https://liff.line.me/<USER_LIFF_ID>）
        ↓
③ ミニアプリ起動（LINEアプリ内WebView）
        ↓
④ サイレントログイン（liff.getIDToken → Supabase Auth）
        ↓
⑤ 店舗閲覧・商品注文・受取チケット表示
        ↓
⑥ 次回以降はトークから1タップ起動
        （リッチメニュー・固定メッセージ・通知内ボタン）
```

------------------------------------------------------------------------

## ⚙️ 技術構成

  要素             内容
  ---------------- ---------------------------------------------------
  認証             LINEログイン（LIFF IDトークン → Supabase Auth）
  通知             Messaging API（受取リマインド、キャンペーン通知）
  再訪導線         リッチメニュー／固定メッセージ内ボタン
  データ管理       Supabase（ユーザー・注文・チケット・店舗情報）
  セッション維持   Supabase Auth セッション + LIFFサイレント認証

------------------------------------------------------------------------

## 🧩 リッチメニュー設計例

  -------------------------------------------------------------------------------------------
  ボタン          遷移先（LIFF URL）                                 備考
  --------------- -------------------------------------------------- ------------------------
  🛒 注文する     `https://liff.line.me/<USER_LIFF_ID>?redirect=/`   トップ画面（店舗一覧）

  🎟 受取チケット  `...?redirect=/tickets`                            チケット表示画面

  📜 注文履歴     `...?redirect=/orders`                             過去履歴一覧

  🏬 店舗情報     `...?redirect=/stores`                             参加店舗案内

  💬 サポート     LINEトークを開く                                   運営への問い合わせ
  -------------------------------------------------------------------------------------------

> ※ 各ボタンのURLは LIFF ID に統一し、`redirect`
> パラメータで遷移先を指定。

------------------------------------------------------------------------

## 📬 自動メッセージ例（友だち追加直後）

    【すーちゃんラーメン】
    ご登録ありがとうございます🍜

    アプリからご注文・受取ができます！
    下のボタンをタップして今すぐスタート👇

    [ ミニアプリを開く ]（https://liff.line.me/<USER_LIFF_ID>）

> Messaging API
> のあいさつメッセージ設定、またはLINE公式アカウントマネージャーの「応答メッセージ」で設定。

------------------------------------------------------------------------

## 🔒 認証・識別の仕組み

  -----------------------------------------------------------------------------------
  項目                                内容
  ----------------------------------- -----------------------------------------------
  ユーザー識別                        LIFF の ID トークン（`sub`）と Supabase の
                                      `auth_user_id`

  認証方式                            `signInWithIdToken()` によるサイレントログイン

  データ関連付け                      `orders.auth_user_id`、`tickets.auth_user_id`
                                      で管理

  友だち追加確認                      `liff.getFriendship()` により追加状態確認可

  通知送信                            `line_user_id`（= `sub`）を保持して Messaging
                                      API 送信
  -----------------------------------------------------------------------------------

------------------------------------------------------------------------

## 🔁 再訪動線の強化策

  ----------------------------------------------------------------------------------------------
  導線                   動作内容                                   表示条件
  ---------------------- ------------------------------------------ ----------------------------
  リッチメニュー         アプリ機能をボタン化（常時表示）           友だち登録済のみ

  トーク固定メッセージ   「アプリを開く」ボタン付き案内             手動または自動配信

  通知リンク             「受取時間が近づいています」→              特定イベント時
                         ミニアプリURLへ                            

  店頭QR                 新規・未登録者向け（友だち追加導線付き）   常設掲示
  ----------------------------------------------------------------------------------------------

------------------------------------------------------------------------

## ✅ まとめ

  項目             内容
  ---------------- ---------------------------------------------
  公式アカウント   共通（ユーザー/店舗どちらも同一でOK）
  初回アクセス     友だち追加 → 自動メッセージでミニアプリ起動
  再訪方法         トーク（リッチメニュー or 固定メッセージ）
  認証             LINEログイン（LIFF + Supabase Auth）
  通知             Messaging API で配信可能
  メリット         再訪率・通知開封率・ブランド統一性が向上

------------------------------------------------------------------------

**最終更新:** 2025-10-23\
**作成者:** アプリ開発支援チーム（ユーザー導線設計担当）

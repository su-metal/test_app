# 本番切り替え時チェックリスト

作成日: 2025-10-22

---

## 1. 認証の本番化
- `/admin/*` と `/api/admin/*` は **ログイン必須** にする（サーバー側で Supabase セッション検証）。
- 簡易ヘッダ鍵（`ADMIN_DASHBOARD_SECRET`）は **撤去**。必要なら本番用環境変数で合わせる。

## 2. RLS/DB権限の最終確認
- `store_applications` は **Select禁止（anon/auth）**、**service_roleのみ全権**。
- `stores` / `orders` も想定ロール以外は読めない／書けないことを確認。
- 重複申請防止には `store_applications.email` にユニーク制約を追加。

## 3. サーバーキーの扱い
- `SUPABASE_SERVICE_ROLE_KEY` は **サーバー専用**（Route Handler / Edge Functions のみで使用）。
- クライアントビルド出力に露出していないかを確認。

## 4. CORS / Origin / クッキー
- 管理APIは **許可オリジンを本番ドメインに限定**。
- クッキーは `Secure` / `HttpOnly` / `SameSite=Lax or Strict` を確認。

## 5. CSP（Content Security Policy）の最終調整
- `connect-src` に Supabase / Stripe / LINE など必要ドメインを漏れなく追加。
- `img-src` / `frame-src` も Stripe 等を許可し、不要なワイルドカードは避ける。

## 6. 監視とログ
- Vercel / Supabase の **エラーログ** と **アラート通知** を有効化。
- 承認APIで失敗時のエラーログを残す。

## 7. レート制限 / 悪用対策
- 承認・一覧APIに簡易レート制限を追加、または社内IP／ロールで防御。

## 8. バックアップ / ロールバック
- 本番前に DB スナップショットを取得。
- 承認APIを一時停止できる **feature flag** を用意。

---

## 本番直前に整理しておく情報
- 本番ドメイン（ユーザー / 店舗）
- 管理者のログイン方法（メール+PW／LINEログイン など）
- `/admin` にアクセスできるロール方針
- 通知（メール / LINE）の文面と送信元

---

本番化直前に「本番化いこう」と声をかけてください。
このチェックリストをもとに、差し替えコードと設定コマンドを一式提示します。
